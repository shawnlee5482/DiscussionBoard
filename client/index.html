<!DOCTYPE html>
<html>
  <head>
    <title></title>
 <!-- THESE TWO VERSIONS BELOW MUST MATCH!!!! -->
    <script src="//ajax.googleapis.com/ajax/libs/angularjs/1.3.5/angular.min.js"></script>
    <script src="//ajax.googleapis.com/ajax/libs/angularjs/1.3.5/angular-route.min.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.0/jquery.min.js"></script>
    <script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
    <script>
    //  inject the ngRoute dependency in the module.
    var myApp = angular.module('myApp', ['ngRoute']);

    // setup route
    myApp.config(function($routeProvider) {
        $routeProvider
        .when('/customers', {
            templateUrl: 'partial/customers.html'})
        .when('/products', {
            templateUrl: 'partial/products.html'})
        .when('/orders', {
            templateUrl: 'partial/orders.html'})  
        .when('/dashboard', {
            templateUrl: 'partial/dashboard.html'}) 
        .when('/login', {
            templateUrl: 'partial/login.html'})
        .when('/user/:id', {
            templateUrl: 'partial/userProfile.html', controller: 'userProfileController'})
        .when('/topic/:id', {
            templateUrl: 'partial/topicDetail.html', controller: 'topicDetailController'})
        .otherwise( {
            templateUrl: 'partial/login.html'}) 
    });

    // loginFactory
    myApp.factory('loginFactory', function($http) {
        var factory = {};
        factory.loggedUser = null;

        factory.getLoggedUser = function() {
          return factory.loggedUser;
        }

        factory.addUser = function(name, callback) {
          // should store at db
            $http.post('/users', {name: name}).success(function(output) {
                factory.loggedUser = output;
                console.log('registered user info = ', output);               
                callback(output);  //output is the complete user list
            });
        }

        factory.logout = function(user, callback) {
          factory.loggedUser = null; 
        };

        factory.getUserInfo = function(id, callback) {
            console.log('getUserInfo', id);
            $http.get('/user/'+ id).success(function(output) {
                console.log('factory.getUserInfo', output);
                callback(output);
            });
        }

        return factory;
    });

    myApp.controller('userProfileController', function ($scope, $routeParams, loginFactory)
    {
      $scope.getUserProfile = function() {
        loginFactory.getUserInfo($routeParams.id, function(data) {
            console.log(data);
            $scope.name = data.name;
            $scope.topic = data.numTopic;
            $scope.post = data.numPost;
            $scope.comment = data.numComment;
        });
      };
    }); 

    myApp.factory('topicFactory', function($http) {
        var factory = [];

        factory.up = function(id, callback) {
          $http.get('/post/' + id + '/up').success(function(output) {
              console.log('topicFactory after factory.up', output);
              callback(output);  //output is the topic list fetched from db
          });          
        };

        factory.down = function(id, callback) {
          $http.get('/post/' + id + '/down').success(function(output) {
              console.log('topicFactory after factory.down', output);
              callback(output);  //output is the topic list fetched from db
          });          
        };

        factory.getTopics = function(callback) {
          $http.get('/topics').success(function(output) {
              console.log('topicFactory', output);
              callback(output);  //output is the topic list fetched from db
          });          
        };

        factory.getTopicDetails = function(id, callback) {
          $http.get('/topic/' + id).success(function(output) {
              console.log('topicFactory: getTopicDetails = ', output);            
              callback(output);
          });
        }

        factory.addTopic = function(topic, id, category, description, callback) {
            var p = {topic:topic, id:id, category:category, description:description};
            p.date = (new Date()).getTime();
            $http.post('/topics', p).success(function(output) {
                callback(output);  //output is the complete user list
            });
        };

        factory.addUser = function(name, callback) {
          // should store at db
            var p = {name:name};
            $http.post('/users', p).success(function(output) {
                callback(output);  //output is the complete user list
            });
        };

        factory.addPost = function(topicId, postContent, userId, callback) {
            var p = {postContent:postContent, id:userId};
            $http.post('/topic/' + topicId, p).success(function(output) {
                callback(output);  //output is the complete user list
            });            
        };

        factory.addComment = function(topicId, postId, userId, comment, callback) {
            var p = {topicId:topicId, userId: userId, comment:comment};
            $http.post('/post/' + postId, p).success(function(output) {
                callback(output);  //output is the complete user list
            });            
        };        
        return factory;
    });    

    //  orders controller
    myApp.controller('dashboardController', function($scope, loginFactory, topicFactory, $location) {

      $scope.getLoggedUser = function() {
        if(!loginFactory.getLoggedUser()) {
          $location.url('/login');
        } else return loginFactory.getLoggedUser();
      };

      $scope.addTopic = function() {
          topicFactory.addTopic($scope.topicName, loginFactory.getLoggedUser(), $scope.topicCategory, 
            $scope.topicDescription, function(data) {
            topicFactory.getTopics(function(d) {
              $scope.topics = d;
              console.log($scope.topics);
            }); 
          });
      };

      $scope.getTopics = function() {
          // to fill select option menu for customers
          topicFactory.getTopics(function(data) {
              $scope.topics = data;
              console.log($scope.topics);              
          });                     
      }   

    });

    myApp.controller('loginController', function ($scope, loginFactory, $location)
    {
      $scope.login = function() {
        loginFactory.addUser($scope.loginName, function(data) {
          // now move to dashboard  
          $location.url('/dashboard');          
        });

      };

      $scope.getLoggedUser = function() {
        return loginFactory.getLoggedUser();
      };
    });    

    myApp.controller('topicDetailController', function ($scope, $routeParams, topicFactory, loginFactory, $location)
    {
      $scope.up = function(post) {
         topicFactory.up(post._id, function(data) {
            console.log('topicFactory.up data=', data.upCount);
            post.upCount = data.upCount;
         });        
      };

      $scope.down = function(post) {
         topicFactory.down(post._id, function(data) {
             console.log('topicFactory.down data=', data.downCount);
             post.downCount = data.downCount;
         });  
      };

      $scope.addPost = function(postContent) {
        console.log('topiccccc', $scope.topic)
        console.log('topicDeatailController: input parameters:', $scope.topic._id, postContent, $scope.currentUser._id);
        topicFactory.addPost($scope.topic._id, postContent, $scope.currentUser._id, function(data) {
          // data contains posts
          console.log('topicDetailController: response of addPost', data);
          topicFactory.getTopicDetails($scope.topic._id, function(data) {
              console.log('topicDetailController: data=', data);
              $scope.topic = data;
          });          
        });
      };

      $scope.getTopicDetails = function() {
        $scope.currentUser = loginFactory.getLoggedUser();  // here we set current user
        if(!$scope.currentUser) {
          $location.url('/login');
          return;
        }

        console.log('getTopicDetails:', $routeParams.id);
        topicFactory.getTopicDetails($routeParams.id, function(data) {
            console.log('topicDetailController: data=', data);
            $scope.topic = data;
            console.log('getTopicDetails: data.description', $scope.topic);
        });
      };

      $scope.addComment = function(post, comment) {
        console.log('topicDetailController-addComment-before Factory addPost', $scope.topic._id, post._id, $scope.currentUser._id, comment);
        topicFactory.addComment($scope.topic._id, post._id, $scope.currentUser._id, comment, function(data) {
            console.log('addComment response from server', data);
            topicFactory.getTopicDetails($routeParams.id, function(data) {
                console.log('topicDetailController: data=', data);
                $scope.topic = data;
            });            
        });
      };

    }); 

    </script>

  </head>
  <body>
    <div id="main" ng-app='myApp'>
<!--         <a href="#dashboard">Dashboard</a>
        <a href="#customers">Customers</a> 
        <a href="#products">Products</a>
        <a href="#orders">Orders</a>
        <a href="#login">Login</a><br><hr> -->
        <div ng-view=""></div>
    </div>
  </body>
</html>